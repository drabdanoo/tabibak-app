<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Console Fix - Admin Claims Setter</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; }
        .warning { background: #fff3cd; color: #856404; padding: 15px; border-radius: 5px; border: 1px solid #ffeaa7; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; }
        .info { background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 5px; }
        button { padding: 12px 20px; margin: 8px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .primary { background: #007bff; color: white; }
        .success-btn { background: #28a745; color: white; }
        .danger { background: #dc3545; color: white; }
        .warning-btn { background: #ffc107; color: black; }
        code { background: #e9ecef; padding: 2px 6px; border-radius: 3px; font-family: 'Courier New', monospace; }
        .code-block { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 6px; overflow-x: auto; }
        .result { margin: 15px 0; padding: 15px; border-radius: 6px; font-family: monospace; white-space: pre-wrap; }
        h1 { color: #2c3e50; text-align: center; }
        h2 { color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 8px; }
        .step { margin: 15px 0; padding: 15px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px; }
        .method { margin: 20px 0; padding: 20px; border: 2px solid #dee2e6; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Firebase Console Fix - Admin Setup</h1>
        
        <div class="warning">
            <strong>‚ö†Ô∏è Firebase Console Issue Detected</strong><br>
            Users in Firebase Authentication console are not clickable. This is a common browser/console issue.
        </div>

        <!-- Method 1: Browser Fixes -->
        <div class="method">
            <h2>Method 1: Browser Troubleshooting</h2>
            
            <div class="step">
                <strong>Step 1:</strong> Try different browsers
                <ul>
                    <li>Chrome (try incognito mode)</li>
                    <li>Firefox</li>
                    <li>Edge</li>
                    <li>Safari (if on Mac)</li>
                </ul>
            </div>

            <div class="step">
                <strong>Step 2:</strong> Clear browser data
                <ul>
                    <li>Clear cache and cookies for firebase.google.com</li>
                    <li>Disable browser extensions</li>
                    <li>Try private/incognito mode</li>
                </ul>
            </div>

            <div class="step">
                <strong>Step 3:</strong> Console URL alternatives
                <button class="primary" onclick="openDirectUrl()">üì± Try Mobile View</button>
                <button class="primary" onclick="openAlternateConsole()">üîÑ Try Alternate Console</button>
                <button class="primary" onclick="openClassicConsole()">üìú Try Legacy Console</button>
            </div>
        </div>

        <!-- Method 2: Firebase CLI -->
        <div class="method">
            <h2>Method 2: Firebase CLI (Recommended)</h2>
            
            <div class="info">
                <strong>üí° Best Solution:</strong> Use Firebase CLI to set custom claims directly
            </div>

            <div class="step">
                <strong>Step 1:</strong> Get your user UID
                <button class="success-btn" onclick="getCurrentUID()">üìã Get My UID</button>
                <div id="uidResult" class="result"></div>
            </div>

            <div class="step">
                <strong>Step 2:</strong> Install Firebase CLI (if not installed)
                <div class="code-block">npm install -g firebase-tools</div>
            </div>

            <div class="step">
                <strong>Step 3:</strong> Login to Firebase
                <div class="code-block">firebase login</div>
            </div>

            <div class="step">
                <strong>Step 4:</strong> Set custom claims using CLI
                <div class="code-block" id="cliCommand">firebase auth:set-custom-user-claims [YOUR_UID] '{"admin":true,"patient":false}' --project medconnect-2</div>
                <button class="warning-btn" onclick="copyCommand()">üìã Copy Command</button>
            </div>
        </div>

        <!-- Method 3: Cloud Function -->
        <div class="method">
            <h2>Method 3: Emergency Admin Function</h2>
            
            <div class="warning">
                <strong>‚ö†Ô∏è Emergency Use Only:</strong> This temporarily bypasses admin checks
            </div>

            <button class="danger" onclick="createEmergencyAdminFunction()">üö® Create Emergency Admin Function</button>
            <div id="emergencyResult" class="result"></div>
        </div>

        <!-- Method 4: Manual Database -->
        <div class="method">
            <h2>Method 4: Direct Database Method</h2>
            
            <div class="step">
                <strong>Alternative:</strong> Modify security rules temporarily to allow self-promotion
                <button class="warning-btn" onclick="createSelfPromoteRule()">‚ö° Create Self-Promote Rule</button>
                <button class="success-btn" onclick="promoteMyself()">üëë Make Myself Admin</button>
                <button class="danger" onclick="restoreSecureRules()">üîí Restore Secure Rules</button>
                <div id="selfPromoteResult" class="result"></div>
            </div>
        </div>

        <!-- Status Section -->
        <div class="section">
            <h2>üîç Current Status</h2>
            <button class="primary" onclick="checkCurrentStatus()">üîÑ Check Auth Status</button>
            <div id="statusResult" class="result"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCHiS1JxbIm5zclg1QxM-i8DvHPeWMPne0",
            authDomain: "medconnect-2.firebaseapp.com", 
            projectId: "medconnect-2",
            storageBucket: "medconnect-2.firebasestorage.app",
            messagingSenderId: "131325717519",
            appId: "1:131325717519:web:5476819a47e487b5e31c32"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.functions();

        let currentUser = null;

        auth.onAuthStateChanged((user) => {
            currentUser = user;
        });

        // Method 1: Browser fixes
        function openDirectUrl() {
            window.open("https://console.firebase.google.com/u/0/project/medconnect-2/authentication/users", "_blank");
        }

        function openAlternateConsole() {
            window.open("https://console.firebase.google.com/project/medconnect-2/authentication/users?hl=en", "_blank");
        }

        function openClassicConsole() {
            window.open("https://console.firebase.google.com/project/medconnect-2/authentication/users?fb_gclid=legacy", "_blank");
        }

        // Method 2: CLI method
        async function getCurrentUID() {
            if (!currentUser) {
                log("uidResult", "‚ùå Please sign in first\n\nGo back to custom-claims-manager.html and sign in", "error");
                return;
            }

            const uid = currentUser.uid;
            document.getElementById("cliCommand").textContent = `firebase auth:set-custom-user-claims ${uid} '{"admin":true,"patient":false}' --project medconnect-2`;
            
            log("uidResult", `‚úÖ Your UID: ${uid}\n\nCommand updated below. Copy and run it in your terminal.`, "success");
        }

        function copyCommand() {
            const command = document.getElementById("cliCommand").textContent;
            navigator.clipboard.writeText(command).then(() => {
                alert("‚úÖ Command copied to clipboard!");
            });
        }

        // Method 3: Emergency function
        async function createEmergencyAdminFunction() {
            log("emergencyResult", "üîÑ Creating emergency admin function...", "info");
            
            const emergencyFunctionCode = `
// Emergency admin function - REMOVE AFTER USE
exports.emergencyMakeAdmin = functions.https.onCall(async (data, context) => {
  if (!context.auth) {
    throw new functions.https.HttpsError("unauthenticated", "Must be authenticated");
  }
  
  const uid = context.auth.uid;
  
  try {
    await admin.auth().setCustomUserClaims(uid, {
      admin: true,
      patient: false,
      emergency: true
    });
    
    await db.collection("users").doc(uid).set({
      role: "admin",
      emergencyPromotion: true,
      promotedAt: admin.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
    
    return { success: true, message: "Emergency admin promotion successful", uid: uid };
  } catch (error) {
    throw new functions.https.HttpsError("internal", "Emergency promotion failed: " + error.message);
  }
});`;

            log("emergencyResult", `‚ö†Ô∏è EMERGENCY FUNCTION CODE:\n\n${emergencyFunctionCode}\n\nüìã INSTRUCTIONS:\n1. Add this code to functions/index.js\n2. Deploy: firebase deploy --only functions\n3. Call the function from custom-claims-manager.html\n4. REMOVE the function after use!`, "warning");
        }

        // Method 4: Self-promotion
        async function createSelfPromoteRule() {
            const tempRule = `
rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {
    // TEMPORARY: Allow authenticated users to promote themselves
    match /users/{uid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }
    
    // Allow all other access temporarily
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}`;

            log("selfPromoteResult", `‚ö†Ô∏è TEMPORARY RULE CREATED:\n\n${tempRule}\n\nüìã STEPS:\n1. Replace firestore.rules with above content\n2. Deploy: firebase deploy --only firestore:rules\n3. Click "Make Myself Admin" below\n4. Click "Restore Secure Rules" after promotion\n\n‚ö†Ô∏è WARNING: This temporarily removes security!`, "warning");
        }

        async function promoteMyself() {
            if (!currentUser) {
                log("selfPromoteResult", "‚ùå Please sign in first", "error");
                return;
            }

            try {
                await db.collection("users").doc(currentUser.uid).set({
                    uid: currentUser.uid,
                    role: "admin",
                    selfPromoted: true,
                    promotedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    needsCustomClaims: true
                }, { merge: true });

                log("selfPromoteResult", `‚úÖ User document updated with admin role!\n\nUID: ${currentUser.uid}\n\nüìã NEXT STEPS:\n1. Still need to set custom claims via CLI or console\n2. Use: firebase auth:set-custom-user-claims ${currentUser.uid} '{"admin":true}' --project medconnect-2\n3. Restore secure rules after setting claims`, "success");
            } catch (error) {
                log("selfPromoteResult", `‚ùå Self-promotion failed: ${error.message}`, "error");
            }
        }

        async function restoreSecureRules() {
            const secureRules = `// Secure rules restored - deploy these to firestore.rules
rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {
    function signedIn() { return request.auth != null; }
    function isAdmin() { return signedIn() && request.auth.token.admin == true; }
    function isDoctor() { return signedIn() && request.auth.token.doctor == true; }
    function isSelf(uid) { return signedIn() && request.auth.uid == uid; }

    match /users/{uid} {
      allow read, write: if isSelf(uid) || isAdmin();
    }

    match /doctors/{uid} {
      allow read: if signedIn();
      allow write: if isSelf(uid) || isAdmin();
    }

    match /appointments/{id} {
      allow create: if signedIn() && request.resource.data.patientId == request.auth.uid;
      allow read: if signedIn() && (
        resource.data.patientId == request.auth.uid ||
        (isDoctor() && resource.data.doctorId == request.auth.uid) ||
        isAdmin()
      );
      allow update: if signedIn() && (
        resource.data.patientId == request.auth.uid ||
        (isDoctor() && resource.data.doctorId == request.auth.uid) ||
        isAdmin()
      );
      allow delete: if isAdmin();
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}`;

            log("selfPromoteResult", `ÔøΩÔøΩ SECURE RULES:\n\n${secureRules}\n\nüìã Replace firestore.rules with above content and deploy:\nfirebase deploy --only firestore:rules`, "info");
        }

        async function checkCurrentStatus() {
            if (!currentUser) {
                log("statusResult", "‚ùå Not authenticated\n\nGo to custom-claims-manager.html and sign in first", "error");
                return;
            }

            try {
                const tokenResult = await currentUser.getIdTokenResult();
                const claims = tokenResult.claims;
                
                log("statusResult", `‚úÖ AUTHENTICATION STATUS:\n\nUID: ${currentUser.uid}\nEmail: ${currentUser.email || "None"}\nProvider: ${currentUser.providerData[0]?.providerId || "anonymous"}\n\nCUSTOM CLAIMS:\n${JSON.stringify(claims, null, 2)}\n\n${claims.admin ? "üéâ Admin access: YES" : "‚ö†Ô∏è Admin access: NO"}`, claims.admin ? "success" : "warning");
            } catch (error) {
                log("statusResult", `‚ùå Error checking status: ${error.message}`, "error");
            }
        }

        function log(elementId, message, type = "info") {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type === "error" ? "error" : type === "success" ? "success" : type === "warning" ? "warning" : "info"}`;
        }
    </script>
</body>
</html>
