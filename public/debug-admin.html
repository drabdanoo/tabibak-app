<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🐛 DEBUG: لوحة الإدارة - MedConnect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-check-compat.js"></script>
    <script src="config.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .hover-scale {
            transition: transform 0.2s ease;
        }
        .hover-scale:hover {
            transform: scale(1.02);
        }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-confirmed { background: #d1fae5; color: #065f46; }
        .status-completed { background: #dbeafe; color: #1e40af; }
        .status-cancelled { background: #fee2e2; color: #991b1b; }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal.show {
            display: flex !important;
            align-items: center;
            justify-content: center;
        }
        
        #adminContent { display: block; }
        
        /* DEBUG PANEL STYLES */
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px;
            font-size: 12px;
            max-width: 450px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 10000;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            border: 2px solid #00ff00;
        }
        
        .debug-controls {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 10001;
        }
        
        .debug-highlight {
            background-color: rgba(255, 255, 0, 0.3);
            border: 2px dashed #ffff00;
            transition: all 0.3s;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- DEBUG WARNING BANNER -->
    <div class="bg-red-600 text-white text-center py-2 font-bold">
        🐛 DEBUG VERSION - Admin Dashboard - للمطورين فقط
    </div>

    <!-- Main Admin Dashboard Content -->
    <div id="adminContent">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-blue-500">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center space-x-4 space-x-reverse">
                    <!-- Back Button -->
                    <button onclick="window.location.href='index.html'" title="العودة للصفحة الرئيسية" class="bg-gray-100 hover:bg-gray-200 text-gray-600 p-2 rounded-full transition-all duration-200 mr-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                    </button>
                    
                    <!-- Production Version Link -->
                    <button onclick="window.location.href='admin.html'" class="bg-green-100 hover:bg-green-200 text-green-600 p-2 rounded-full transition-all duration-200 mr-2" title="الانتقال للنسخة الإنتاجية">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </button>
                    
                    <div class="bg-blue-500 p-3 rounded-full">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">🐛 لوحة الإدارة (DEBUG)</h1>
                        <p class="text-gray-600">نسخة التطوير مع أدوات التشخيص</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <div class="text-right">
                        <p class="text-sm text-gray-600">مرحباً</p>
                        <p class="font-semibold text-gray-900">المدير (DEBUG)</p>
                    </div>
                    <button onclick="handleLogout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                        تسجيل الخروج
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- DEBUG CONTROLS -->
    <div class="debug-controls">
        <button onclick="DEBUG.clear()" class="bg-red-600 text-white px-3 py-1 rounded mr-2">Clear Logs</button>
        <button onclick="DEBUG.export()" class="bg-blue-600 text-white px-3 py-1 rounded mr-2">Export Logs</button>
        <button onclick="DEBUG.togglePanel()" class="bg-green-600 text-white px-3 py-1 rounded">Toggle Panel</button>
    </div>

    <!-- Simplified Content for DEBUG version -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold mb-4">🐛 أدوات التشخيص</h2>
            
            <!-- Debug Tools -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                <button onclick="testFirebaseConnection()" class="bg-blue-500 text-white p-4 rounded-lg hover:bg-blue-600">
                    اختبار الاتصال بـ Firebase
                </button>
                <button onclick="testAuthentication()" class="bg-green-500 text-white p-4 rounded-lg hover:bg-green-600">
                    اختبار المصادقة
                </button>
                <button onclick="testDatabaseRead()" class="bg-purple-500 text-white p-4 rounded-lg hover:bg-purple-600">
                    اختبار قراءة قاعدة البيانات
                </button>
                <button onclick="testDatabaseWrite()" class="bg-orange-500 text-white p-4 rounded-lg hover:bg-orange-600">
                    اختبار كتابة قاعدة البيانات
                </button>
                <button onclick="simulateError()" class="bg-red-500 text-white p-4 rounded-lg hover:bg-red-600">
                    محاكاة خطأ
                </button>
                <button onclick="DEBUG.showSystemInfo()" class="bg-gray-500 text-white p-4 rounded-lg hover:bg-gray-600">
                    معلومات النظام
                </button>
            </div>

            <!-- Basic Admin Functions -->
            <div class="border-t pt-6">
                <h3 class="text-xl font-bold mb-4">الوظائف الأساسية</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="loadDoctors()" class="bg-indigo-500 text-white p-3 rounded-lg hover:bg-indigo-600">
                        تحميل الأطباء
                    </button>
                    <button onclick="loadAppointments()" class="bg-teal-500 text-white p-3 rounded-lg hover:bg-teal-600">
                        تحميل المواعيد
                    </button>
                    <button onclick="initializeExistingDoctors()" class="bg-orange-500 text-white p-3 rounded-lg hover:bg-orange-600">
                        إنشاء الأطباء الأساسيين
                    </button>
                </div>
            </div>
        </div>
    </div>

    </div>

    <script>
        // ===== ENHANCED DEBUG SYSTEM =====
        const DEBUG = {
            logs: [],
            panelVisible: true,
            
            log: function(step, message, data = null) {
                const timestamp = new Date().toISOString().slice(11, 23);
                const logEntry = {timestamp, step, message, data, type: 'info'};
                console.log(`🐛 [${timestamp}] STEP ${step}: ${message}`, data || '');
                this.logs.push(logEntry);
                this.updateDebugDisplay();
            },
            
            error: function(step, message, error) {
                const timestamp = new Date().toISOString().slice(11, 23);
                const logEntry = {timestamp, step, message: `❌ ERROR: ${message}`, data: error, type: 'error'};
                console.error('🐛 DEBUG ERROR:', error);
                this.logs.push(logEntry);
                this.updateDebugDisplay();
            },
            
            success: function(step, message, data = null) {
                const timestamp = new Date().toISOString().slice(11, 23);
                const logEntry = {timestamp, step, message: `✅ SUCCESS: ${message}`, data, type: 'success'};
                console.log(`🐛 [${timestamp}] SUCCESS ${step}: ${message}`, data || '');
                this.logs.push(logEntry);
                this.updateDebugDisplay();
            },
            
            updateDebugDisplay: function() {
                let debugDiv = document.getElementById('debug-panel');
                if (!debugDiv) {
                    debugDiv = document.createElement('div');
                    debugDiv.id = 'debug-panel';
                    debugDiv.className = 'debug-panel';
                    document.body.appendChild(debugDiv);
                }
                
                if (!this.panelVisible) {
                    debugDiv.style.display = 'none';
                    return;
                } else {
                    debugDiv.style.display = 'block';
                }
                
                const recentLogs = this.logs.slice(-20);
                debugDiv.innerHTML = `
                    <h4 style="color: #00ff00; margin-bottom: 10px;">🐛 DEBUG LOG (${this.logs.length} entries)</h4>
                    ${recentLogs.map(log => {
                        const color = log.type === 'error' ? '#ff6b6b' : 
                                    log.type === 'success' ? '#51cf66' : '#74c0fc';
                        return `<div style="color: ${color}; margin-bottom: 3px;">
                            [${log.timestamp.slice(-8)}] ${log.step}: ${log.message}
                        </div>`;
                    }).join('')}
                `;
            },
            
            clear: function() {
                this.logs = [];
                this.updateDebugDisplay();
                console.clear();
                this.log('CLEAR', 'Debug logs cleared');
            },
            
            export: function() {
                const data = JSON.stringify(this.logs, null, 2);
                const blob = new Blob([data], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `debug-admin-${new Date().toISOString().slice(0,19)}.json`;
                a.click();
                this.log('EXPORT', 'Debug logs exported to file');
            },
            
            togglePanel: function() {
                this.panelVisible = !this.panelVisible;
                this.updateDebugDisplay();
            },
            
            showSystemInfo: function() {
                const info = {
                    userAgent: navigator.userAgent,
                    url: window.location.href,
                    timestamp: new Date().toISOString(),
                    firebaseLoaded: typeof firebase !== 'undefined',
                    configLoaded: typeof window.__MC_ENV__ !== 'undefined',
                    localStorage: Object.keys(localStorage),
                    sessionStorage: Object.keys(sessionStorage)
                };
                this.log('SYSTEM', 'System information collected', info);
                console.table(info);
            }
        };

        // Override console methods to capture in debug
        const originalConsoleError = console.error;
        console.error = function(...args) {
            DEBUG.error('CONSOLE', 'Console error captured', args);
            originalConsoleError.apply(console, args);
        };

        // Initialize Firebase and check authentication
        let db;
        let appointments = [];
        let doctors = [];
        let currentAppointment = null;
        
        function initializeFirebaseAndAuth() {
            DEBUG.log('INIT', '🔧 Starting Firebase initialization...');
            
            try {
                DEBUG.log('INIT', '🔍 Checking Firebase SDK...');
                if (typeof firebase === 'undefined') {
                    DEBUG.error('INIT', 'Firebase SDK not loaded');
                    alert('Firebase SDK not loaded. Check your internet connection.');
                    return;
                }
                
                DEBUG.log('INIT', '🔍 Checking Firebase config...');
                if (typeof window.__MC_ENV__ === 'undefined') {
                    DEBUG.error('INIT', 'Config object not found');
                    alert('Configuration not loaded. Please refresh the page.');
                    return;
                }
                
                if (!window.__MC_ENV__.FIREBASE_CONFIG) {
                    DEBUG.error('INIT', 'Firebase config not found in __MC_ENV__');
                    alert('Firebase configuration missing.');
                    return;
                }
                
                DEBUG.log('INIT', '🔧 Initializing Firebase...');
                firebase.initializeApp(window.__MC_ENV__.FIREBASE_CONFIG);
                db = firebase.firestore();
                
                DEBUG.success('INIT', 'Firebase initialized successfully');
                
                setTimeout(() => {
                    DEBUG.log('INIT', '🔍 Starting authentication check...');
                    checkAuthentication();
                }, 100);
                
            } catch (error) {
                DEBUG.error('INIT', 'Firebase initialization failed', error);
                alert('Firebase initialization failed: ' + error.message);
            }
        }

        // Authentication check with enhanced debugging
        function checkAuthentication() {
            DEBUG.log('1', 'Starting authentication check...');
            
            const adminSession = localStorage.getItem('medconnect_admin_session');
            if (!adminSession) {
                DEBUG.log('2', '❌ No admin session found');
                redirectToLogin();
                return;
            }
            DEBUG.log('2', '✅ Session found in localStorage', adminSession.slice(0, 100) + '...');
            
            let session;
            try {
                session = JSON.parse(adminSession);
                DEBUG.log('3', '✅ Session parsed successfully', {email: session.email, loginTime: session.loginTime});
            } catch (e) {
                DEBUG.error('3', 'Failed to parse session data', e);
                redirectToLogin();
                return;
            }
            
            DEBUG.log('4', 'Checking session expiry...');
            const sessionAge = Date.now() - session.loginTime;
            const maxAge = 24 * 60 * 60 * 1000;
            
            DEBUG.log('4', `Session age: ${Math.round(sessionAge/1000/60)} minutes (max: ${Math.round(maxAge/1000/60/60)} hours)`);
            
            if (sessionAge > maxAge) {
                DEBUG.log('4', '❌ Session expired');
                redirectToLogin();
                return;
            }
            
            DEBUG.success('4', 'Session is valid, checking Firebase auth...');
            
            const auth = firebase.auth();
            let authCheckComplete = false;
            
            const unsubscribe = auth.onAuthStateChanged((user) => {
                if (authCheckComplete) return;
                authCheckComplete = true;
                unsubscribe();
                
                DEBUG.log('5', 'Firebase auth state received', {
                    user: user ? user.email : 'null',
                    uid: user ? user.uid : 'null'
                });
                
                if (!user) {
                    DEBUG.error('5', 'No Firebase user found');
                    redirectToLogin();
                    return;
                }
                
                if (user.email.toLowerCase() !== 'obaidaalluhebe@gmail.com') {
                    DEBUG.error('5', 'Wrong user email', {received: user.email, expected: 'obaidaalluhebe@gmail.com'});
                    redirectToLogin();
                    return;
                }
                
                DEBUG.success('6', 'Authentication complete - DEBUG version ready!');
                loadBasicData();
            });
        }

        function redirectToLogin() {
            DEBUG.log('REDIRECT', '🔄 Redirecting to login page...');
            localStorage.removeItem('medconnect_admin_session');
            window.location.href = 'admin-login.html';
        }

        function loadBasicData() {
            DEBUG.log('LOAD', 'Loading basic dashboard data...');
            // Basic loading for debug version
            DEBUG.success('LOAD', 'Debug dashboard ready');
        }

        function handleLogout() {
            DEBUG.log('LOGOUT', '🚪 Logging out admin...');
            localStorage.removeItem('medconnect_admin_session');
            firebase.auth().signOut();
            window.location.href = 'admin-login.html';
        }

        // DEBUG TEST FUNCTIONS
        function testFirebaseConnection() {
            DEBUG.log('TEST', 'Testing Firebase connection...');
            try {
                if (firebase && db) {
                    DEBUG.success('TEST', 'Firebase connection OK');
                } else {
                    DEBUG.error('TEST', 'Firebase not properly initialized');
                }
            } catch (e) {
                DEBUG.error('TEST', 'Firebase connection failed', e);
            }
        }

        function testAuthentication() {
            DEBUG.log('TEST', 'Testing authentication state...');
            const user = firebase.auth().currentUser;
            if (user) {
                DEBUG.success('TEST', 'User authenticated', {email: user.email, uid: user.uid});
            } else {
                DEBUG.error('TEST', 'No authenticated user');
            }
        }

        async function testDatabaseRead() {
            DEBUG.log('TEST', 'Testing database read...');
            try {
                const snapshot = await db.collection('doctors').limit(1).get();
                DEBUG.success('TEST', 'Database read successful', {size: snapshot.size});
            } catch (e) {
                DEBUG.error('TEST', 'Database read failed', e);
            }
        }

        async function testDatabaseWrite() {
            DEBUG.log('TEST', 'Testing database write...');
            try {
                await db.collection('test').add({
                    message: 'Debug test',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                DEBUG.success('TEST', 'Database write successful');
            } catch (e) {
                DEBUG.error('TEST', 'Database write failed', e);
            }
        }

        function simulateError() {
            DEBUG.log('TEST', 'Simulating error...');
            try {
                throw new Error('Simulated error for testing');
            } catch (e) {
                DEBUG.error('TEST', 'Simulated error thrown', e);
            }
        }

        // Basic functions for testing
        async function loadDoctors() {
            DEBUG.log('DOCTORS', 'Loading doctors...');
            try {
                const snapshot = await db.collection('doctors').get();
                doctors = [];
                snapshot.forEach(doc => doctors.push({id: doc.id, ...doc.data()}));
                DEBUG.success('DOCTORS', `Loaded ${doctors.length} doctors`);
            } catch (e) {
                DEBUG.error('DOCTORS', 'Failed to load doctors', e);
            }
        }

        async function loadAppointments() {
            DEBUG.log('APPOINTMENTS', 'Loading appointments...');
            try {
                const snapshot = await db.collection('appointments').get();
                appointments = [];
                snapshot.forEach(doc => appointments.push({id: doc.id, ...doc.data()}));
                DEBUG.success('APPOINTMENTS', `Loaded ${appointments.length} appointments`);
            } catch (e) {
                DEBUG.error('APPOINTMENTS', 'Failed to load appointments', e);
            }
        }

        async function initializeExistingDoctors() {
            DEBUG.log('INIT_DOCTORS', 'Initializing existing doctors...');
            // Simplified version for debug
            const doctors = [
                { name: 'د. خالد هاشم', email: 'khalid@medconnect.com' },
                { name: 'د. صفوان الهاشمي', email: 'Safwan@medconnect.com' }
            ];
            
            for (const doctor of doctors) {
                DEBUG.log('INIT_DOCTORS', `Processing ${doctor.name}...`);
            }
            
            DEBUG.success('INIT_DOCTORS', 'Doctor initialization complete (debug mode)');
        }

        // Initialize on page load
        window.onload = function() {
            DEBUG.log('PAGE', '🚀 Debug admin dashboard loading...');
            initializeFirebaseAndAuth();
        };
    </script>
</body>
</html>