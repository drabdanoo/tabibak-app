<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® Stable Emergency Admin</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .container { max-width: 700px; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .status-box { padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center; font-weight: bold; font-size: 18px; }
        .authenticated { background: #d4edda; color: #155724; border: 3px solid #28a745; }
        .unauthenticated { background: #f8d7da; color: #721c24; border: 3px solid #dc3545; }
        .admin { background: #dc3545; color: white; border: 3px solid #a71d2a; }
        .patient { background: #6c757d; color: white; border: 3px solid #495057; }
        button { padding: 20px 40px; margin: 15px; border: none; border-radius: 10px; cursor: pointer; font-size: 18px; font-weight: bold; transition: all 0.3s; }
        .emergency { background: #dc3545; color: white; font-size: 20px; } .emergency:hover { background: #a71d2a; transform: scale(1.05); }
        .primary { background: #007bff; color: white; } .primary:hover { background: #0056b3; }
        .success { background: #28a745; color: white; } .success:hover { background: #1e7e34; }
        .warning { background: #ffc107; color: black; } .warning:hover { background: #d39e00; }
        .result { margin: 20px 0; padding: 20px; border-radius: 10px; font-family: monospace; white-space: pre-wrap; font-size: 14px; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .success-bg { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #b8daff; }
        h1 { color: #2c3e50; text-align: center; margin: 0 0 20px 0; font-size: 32px; }
        .user-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .steps { background: #e3f2fd; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: right; }
        .step { margin: 10px 0; padding: 15px; background: white; border-radius: 5px; border-right: 4px solid #2196f3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® Stable Emergency Admin Activation</h1>
        
        <!-- Current Status -->
        <div id="authStatus" class="status-box unauthenticated">üîÑ Checking authentication...</div>
        <div id="userInfo" class="user-info" style="display: none;"></div>

        <!-- Main Action -->
        <div style="text-align: center; margin: 30px 0;">
            <button class="emergency" onclick="makeCurrentUserAdmin()" id="emergencyBtn">
                üö® MAKE ME ADMIN NOW
            </button>
            <br>
            <button class="primary" onclick="refreshStatus()">üîÑ Refresh Status</button>
            <button class="success" onclick="openAdminPanel()">üéõÔ∏è Open Admin Panel</button>
        </div>

        <!-- Result Display -->
        <div id="resultArea"></div>

        <!-- Instructions -->
        <div class="steps">
            <h3>üìã How This Works:</h3>
            <div class="step">
                <strong>Step 1:</strong> Click the big red button above
            </div>
            <div class="step">
                <strong>Step 2:</strong> Wait for success message
            </div>
            <div class="step">
                <strong>Step 3:</strong> Click "Refresh Status" to see admin role
            </div>
            <div class="step">
                <strong>Step 4:</strong> Use "Open Admin Panel" to test admin functions
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCHiS1JxbIm5zclg1QxM-i8DvHPeWMPne0",
            authDomain: "medconnect-2.firebaseapp.com", 
            projectId: "medconnect-2",
            storageBucket: "medconnect-2.firebasestorage.app",
            messagingSenderId: "131325717519",
            appId: "1:131325717519:web:5476819a47e487b5e31c32"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.functions();

        let currentUser = null;
        let currentClaims = {};

        // Auth state listener
        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            await updateStatus();
        });

        async function updateStatus() {
            const statusEl = document.getElementById("authStatus");
            const userInfo = document.getElementById("userInfo");
            const emergencyBtn = document.getElementById("emergencyBtn");
            
            if (!currentUser) {
                statusEl.className = "status-box unauthenticated";
                statusEl.innerHTML = "‚ùå NOT AUTHENTICATED<br>Please sign in first";
                userInfo.style.display = "none";
                emergencyBtn.disabled = true;
                return;
            }

            try {
                const tokenResult = await currentUser.getIdTokenResult(true); // Force refresh
                currentClaims = tokenResult.claims;
                
                const isAdmin = currentClaims.admin || false;
                const isPatient = currentClaims.patient || false;
                const isEmergency = currentClaims.emergency || false;
                
                // Determine status
                if (isAdmin) {
                    statusEl.className = "status-box admin";
                    statusEl.innerHTML = `‚úÖ ADMIN ACCESS CONFIRMED ${isEmergency ? '(Emergency)' : ''}`;
                    emergencyBtn.innerHTML = "‚úÖ Already Admin!";
                    emergencyBtn.disabled = true;
                } else if (isPatient) {
                    statusEl.className = "status-box patient";
                    statusEl.innerHTML = "üë§ PATIENT ROLE - Need Admin Upgrade";
                    emergencyBtn.innerHTML = "üö® MAKE ME ADMIN NOW";
                    emergencyBtn.disabled = false;
                } else {
                    statusEl.className = "status-box authenticated";
                    statusEl.innerHTML = "‚úÖ AUTHENTICATED - No Role Assigned";
                    emergencyBtn.innerHTML = "üö® MAKE ME ADMIN NOW";
                    emergencyBtn.disabled = false;
                }
                
                userInfo.style.display = "block";
                userInfo.innerHTML = `
                    <h3>üë§ Current User Details:</h3>
                    <strong>UID:</strong> <code>${currentUser.uid}</code><br>
                    <strong>Email:</strong> ${currentUser.email || "None"}<br>
                    <strong>Phone:</strong> ${currentUser.phoneNumber || "None"}<br>
                    <strong>Provider:</strong> ${currentUser.providerData[0]?.providerId || "anonymous"}<br>
                    <strong>Admin:</strong> ${isAdmin ? '‚úÖ Yes' : '‚ùå No'}<br>
                    <strong>Patient:</strong> ${isPatient ? '‚úÖ Yes' : '‚ùå No'}<br>
                    <strong>Emergency:</strong> ${isEmergency ? '‚úÖ Yes' : '‚ùå No'}<br>
                    <strong>Token Issued:</strong> ${new Date(currentClaims.iat * 1000).toLocaleString()}
                `;
                
            } catch (error) {
                console.error("Error getting token:", error);
                statusEl.className = "status-box unauthenticated";
                statusEl.innerHTML = "‚ùå ERROR CHECKING STATUS";
            }
        }

        // Main emergency admin function
        async function makeCurrentUserAdmin() {
            if (!currentUser) {
                showResult("‚ùå ERROR: Not signed in!\n\nPlease go back to another page and sign in first.", "error");
                return;
            }

            const emergencyBtn = document.getElementById("emergencyBtn");
            emergencyBtn.disabled = true;
            emergencyBtn.innerHTML = "üîÑ Processing...";
            
            showResult("üö® Calling emergency admin function...\n\nThis will make you an admin with full system access!", "info");
            
            try {
                const emergencyMakeAdminFunc = functions.httpsCallable("emergencyMakeAdmin");
                const result = await emergencyMakeAdminFunc();
                
                showResult(`üéâ SUCCESS! Emergency admin activation completed!\n\nUID: ${currentUser.uid}\nMessage: ${result.data.message}\n\nNext Steps:\n${result.data.nextSteps ? result.data.nextSteps.join('\n') : '1. Click Refresh Status\n2. Verify admin access\n3. Use admin panel'}\n\n‚ö†Ô∏è ${result.data.warning || 'Remember to remove emergency function after use!'}`, "success");
                
                // Update button
                emergencyBtn.innerHTML = "‚úÖ Admin Activated!";
                emergencyBtn.className = "success";
                
                // Auto-refresh status after 2 seconds
                setTimeout(async () => {
                    await updateStatus();
                    showResult(`üéâ ADMIN ACTIVATION SUCCESSFUL!\n\nYou now have admin access. Click "Open Admin Panel" to test your new powers!`, "success");
                }, 2000);
                
            } catch (error) {
                console.error("Emergency activation failed:", error);
                showResult(`‚ùå EMERGENCY ACTIVATION FAILED!\n\nError Code: ${error.code}\nMessage: ${error.message}\n\nDetails: ${error.details ? JSON.stringify(error.details, null, 2) : 'No additional details'}\n\nTry:\n1. Make sure you're signed in\n2. Check if emergency function is deployed\n3. Try again in a few seconds`, "error");
                
                // Reset button
                emergencyBtn.disabled = false;
                emergencyBtn.innerHTML = "ÔøΩÔøΩ MAKE ME ADMIN NOW";
                emergencyBtn.className = "emergency";
            }
        }

        // Refresh status
        async function refreshStatus() {
            showResult("üîÑ Refreshing authentication status...", "info");
            await updateStatus();
            
            if (currentClaims.admin) {
                showResult("‚úÖ Status refreshed! You have admin access.", "success");
            } else {
                showResult("‚ö†Ô∏è Status refreshed. Still no admin access - try the emergency function.", "info");
            }
        }

        // Open admin panel
        function openAdminPanel() {
            window.open("custom-claims-manager.html", "_blank");
            showResult("üéõÔ∏è Admin panel opened in new tab!", "info");
        }

        // Show result
        function showResult(message, type) {
            const resultArea = document.getElementById("resultArea");
            resultArea.innerHTML = `<div class="result ${type === 'error' ? 'error' : type === 'success' ? 'success-bg' : 'info'}">${message}</div>`;
        }

        // Initialize
        window.addEventListener("load", () => {
            console.log("üö® Stable Emergency Admin Tool loaded");
            showResult("üö® Emergency Admin Tool Ready!\n\nThis page will NOT auto-close. Click the red button when ready.", "info");
        });
    </script>
</body>
</html>
