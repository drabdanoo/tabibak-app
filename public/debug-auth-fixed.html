<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixed Authentication Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 600px; background: white; padding: 20px; border-radius: 10px; }
        .section { margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .primary { background: #007bff; color: white; }
        .success { background: #28a745; color: white; }
        .danger { background: #dc3545; color: white; }
        .warning { background: #ffc107; color: black; }
        .result { margin: 10px 0; padding: 10px; background: #e9ecef; border-radius: 5px; font-family: monospace; white-space: pre-wrap; }
        .error { background: #f8d7da; color: #721c24; }
        .success-bg { background: #d4edda; color: #155724; }
        .config-box { background: #fff3cd; color: #856404; padding: 15px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Fixed Firebase Authentication Debug</h1>
        
        <div class="section">
            <h3>Firebase Configuration</h3>
            <div class="config-box">
                <strong>Using Configuration:</strong><br>
                Project ID: medconnect-2<br>
                API Key: AIzaSyCHiS1JxbIm5zclg1QxM-i8DvHPeWMPne0<br>
                Auth Domain: medconnect-2.firebaseapp.com
            </div>
        </div>
        
        <div class="section">
            <h3>Current Status</h3>
            <div id="status">Loading...</div>
        </div>

        <div class="section">
            <h3>Step 1: Test Authentication</h3>
            <button class="primary" onclick="testAnonymousAuth()">Test Anonymous Sign-In</button>
            <button class="warning" onclick="testWithPhone()">Setup Phone Auth</button>
            <button class="danger" onclick="signOut()">Sign Out</button>
            <div id="authResult" class="result"></div>
        </div>

        <div class="section">
            <h3>Step 2: Enable Authentication Methods</h3>
            <button class="success" onclick="openFirebaseConsole()">Open Firebase Console</button>
            <div class="config-box">
                <strong>Manual Steps:</strong><br>
                1. Click button above to open Firebase Console<br>
                2. Go to Authentication > Sign-in method<br>
                3. Enable "Anonymous" authentication<br>
                4. Enable "Phone" authentication (optional)<br>
                5. Come back and test authentication
            </div>
        </div>

        <div class="section">
            <h3>Step 3: Test Database Access</h3>
            <button class="primary" onclick="testBasicRead()">Test Database Read</button>
            <button class="primary" onclick="testUserWrite()">Test User Write</button>
            <div id="dbResult" class="result"></div>
        </div>

        <div class="section">
            <h3>Step 4: Test Cloud Functions</h3>
            <button class="primary" onclick="testGetUserRole()">Test getUserRole Function</button>
            <div id="funcResult" class="result"></div>
        </div>

        <div class="section">
            <h3>Step 5: Admin Setup</h3>
            <button class="success" onclick="createAdminUser()">Create Admin User Document</button>
            <div id="adminResult" class="result"></div>
            <div class="config-box">
                <strong>After creating user document:</strong><br>
                1. Go to Firebase Console > Authentication > Users<br>
                2. Find your user and click on it<br>
                3. Set custom claims: {"admin": true}<br>
                4. Sign out and sign in again
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

    <script>
        // CORRECTED Firebase configuration from admin.html
        const firebaseConfig = {
            apiKey: "AIzaSyCHiS1JxbIm5zclg1QxM-i8DvHPeWMPne0",
            authDomain: "medconnect-2.firebaseapp.com", 
            projectId: "medconnect-2",
            storageBucket: "medconnect-2.firebasestorage.app",
            messagingSenderId: "131325717519",
            appId: "1:131325717519:web:5476819a47e487b5e31c32"
        };

        console.log("Initializing Firebase with correct config...");
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.functions();

        let currentUser = null;

        // Auth state listener
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            updateStatus();
            
            if (user) {
                console.log("‚úÖ User signed in:", user.uid);
                user.getIdTokenResult().then((tokenResult) => {
                    console.log("Token claims:", tokenResult.claims);
                });
            } else {
                console.log("‚ùå User signed out");
            }
        });

        function updateStatus() {
            const statusEl = document.getElementById("status");
            if (currentUser) {
                statusEl.innerHTML = `
                    <div class="success-bg" style="padding: 15px; border-radius: 5px;">
                        ‚úÖ <strong>AUTHENTICATED</strong><br>
                        UID: ${currentUser.uid}<br>
                        Provider: ${currentUser.providerData[0]?.providerId || "anonymous"}<br>
                        Email: ${currentUser.email || "None"}<br>
                        Phone: ${currentUser.phoneNumber || "None"}<br>
                        Created: ${new Date(currentUser.metadata.creationTime).toLocaleString()}
                    </div>
                `;
            } else {
                statusEl.innerHTML = `
                    <div class="error" style="padding: 15px; border-radius: 5px;">
                        ‚ùå <strong>NOT AUTHENTICATED</strong><br>
                        Please sign in to test other features
                    </div>
                `;
            }
        }

        // Test anonymous authentication
        async function testAnonymousAuth() {
            log("authResult", "üîÑ Testing anonymous authentication...");
            try {
                const result = await auth.signInAnonymously();
                log("authResult", `‚úÖ SUCCESS: Anonymous sign-in completed!\n\nUser Details:\nUID: ${result.user.uid}\nProvider: anonymous\nCreated: ${new Date(result.user.metadata.creationTime).toLocaleString()}\n\nüéâ You can now test database and cloud functions!`, "success");
            } catch (error) {
                console.error("‚ùå Anonymous auth error:", error);
                
                let errorMsg = `‚ùå FAILED: Anonymous sign-in failed\n\nError: ${error.code}\nMessage: ${error.message}\n\n`;
                
                if (error.code === "auth/api-key-not-valid") {
                    errorMsg += "üîß SOLUTION:\n1. API key issue - check Firebase configuration\n2. Verify project settings in Firebase Console";
                } else if (error.code === "auth/operation-not-allowed") {
                    errorMsg += "üîß SOLUTION:\n1. Go to Firebase Console\n2. Authentication > Sign-in method\n3. Enable 'Anonymous' authentication";
                } else {
                    errorMsg += "üîß Check Firebase Console for authentication settings";
                }
                
                log("authResult", errorMsg, "error");
            }
        }

        // Open Firebase Console
        function openFirebaseConsole() {
            window.open("https://console.firebase.google.com/project/medconnect-2/authentication/providers", "_blank");
        }

        // Setup phone authentication
        function testWithPhone() {
            log("authResult", "üì± Phone Authentication Setup\n\nFor phone auth you need:\n1. Enable Phone provider in Firebase Console\n2. Set up reCAPTCHA verification\n3. Add phone number and verification code\n\nüëÜ Use anonymous auth for easier testing", "warning");
        }

        // Sign out
        async function signOut() {
            try {
                await auth.signOut();
                log("authResult", "‚úÖ Signed out successfully", "success");
            } catch (error) {
                log("authResult", `‚ùå Sign out error: ${error.message}`, "error");
            }
        }

        // Test basic database read
        async function testBasicRead() {
            if (!currentUser) {
                log("dbResult", "‚ùå AUTHENTICATION REQUIRED\n\nPlease sign in first using the authentication buttons above.", "error");
                return;
            }

            log("dbResult", "üîÑ Testing database read access...");
            try {
                // Test reading doctors collection (should work with current rules)
                const doctorsSnapshot = await db.collection("doctors").limit(3).get();
                const doctorsCount = doctorsSnapshot.size;
                
                // Test reading test collection
                const testDoc = await db.collection("test").doc("connection").get();
                
                log("dbResult", `‚úÖ DATABASE READ SUCCESS!\n\nResults:\n- Doctors collection: ${doctorsCount} documents accessible\n- Test collection: ${testDoc.exists ? "Document exists" : "Collection accessible"}\n- User authenticated: ${currentUser.uid}`, "success");
            } catch (error) {
                console.error("‚ùå Database read error:", error);
                log("dbResult", `‚ùå DATABASE READ FAILED\n\nError: ${error.code}\nMessage: ${error.message}\n\nThis might be due to:\n1. Firestore rules blocking access\n2. Authentication token issues\n3. Network connectivity`, "error");
            }
        }

        // Test user document write
        async function testUserWrite() {
            if (!currentUser) {
                log("dbResult", "‚ùå AUTHENTICATION REQUIRED\n\nPlease sign in first.", "error");
                return;
            }

            log("dbResult", "üîÑ Testing user document write...");
            try {
                const userData = {
                    uid: currentUser.uid,
                    role: "patient",
                    email: currentUser.email || null,
                    phoneNumber: currentUser.phoneNumber || null,
                    provider: currentUser.providerData[0]?.providerId || "anonymous",
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    testWrite: true
                };
                
                await db.collection("users").doc(currentUser.uid).set(userData, { merge: true });
                
                log("dbResult", `‚úÖ USER DOCUMENT WRITE SUCCESS!\n\nDocument created at: /users/${currentUser.uid}\nRole: patient\nProvider: ${userData.provider}\n\nüéâ User document is ready for role management!`, "success");
            } catch (error) {
                console.error("‚ùå User write error:", error);
                log("dbResult", `‚ùå USER DOCUMENT WRITE FAILED\n\nError: ${error.code}\nMessage: ${error.message}\n\nPossible causes:\n1. Firestore rules blocking write\n2. Insufficient permissions\n3. Network issues`, "error");
            }
        }

        // Test Cloud Function
        async function testGetUserRole() {
            if (!currentUser) {
                log("funcResult", "‚ùå AUTHENTICATION REQUIRED\n\nPlease sign in first.", "error");
                return;
            }

            log("funcResult", "üîÑ Testing getUserRole cloud function...");
            try {
                const getUserRoleFunc = functions.httpsCallable("getUserRole");
                const result = await getUserRoleFunc();
                
                log("funcResult", `‚úÖ CLOUD FUNCTION SUCCESS!\n\nFunction: getUserRole\nResponse: ${JSON.stringify(result.data, null, 2)}\n\nüéâ Cloud Functions are working correctly!`, "success");
            } catch (error) {
                console.error("‚ùå Function error:", error);
                
                let errorMsg = `‚ùå CLOUD FUNCTION FAILED\n\nFunction: getUserRole\nError: ${error.code}\nMessage: ${error.message}\n`;
                
                if (error.details) {
                    errorMsg += `Details: ${JSON.stringify(error.details, null, 2)}\n`;
                }
                
                errorMsg += "\nPossible solutions:\n1. Check if Cloud Functions are deployed\n2. Verify authentication token\n3. Check function permissions";
                
                log("funcResult", errorMsg, "error");
            }
        }

        // Create admin user
        async function createAdminUser() {
            if (!currentUser) {
                log("adminResult", "‚ùå AUTHENTICATION REQUIRED\n\nPlease sign in first.", "error");
                return;
            }

            log("adminResult", "üîÑ Creating admin user document...");
            try {
                const adminData = {
                    uid: currentUser.uid,
                    role: "admin",
                    email: currentUser.email || null,
                    phoneNumber: currentUser.phoneNumber || null,
                    provider: currentUser.providerData[0]?.providerId || "anonymous",
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    adminSetup: true,
                    setupDate: new Date().toISOString()
                };
                
                await db.collection("users").doc(currentUser.uid).set(adminData, { merge: true });
                
                log("adminResult", `‚úÖ ADMIN USER DOCUMENT CREATED!\n\nUser ID: ${currentUser.uid}\nRole: admin\n\nüìã NEXT STEPS:\n1. Go to Firebase Console > Authentication > Users\n2. Click on your user: ${currentUser.uid}\n3. Set custom claims: {"admin": true, "patient": false}\n4. Sign out and sign in again\n5. Test admin functions\n\nüîó Firebase Console: https://console.firebase.google.com/project/medconnect-2/authentication/users`, "success");
            } catch (error) {
                console.error("‚ùå Admin creation error:", error);
                log("adminResult", `‚ùå ADMIN USER CREATION FAILED\n\nError: ${error.code}\nMessage: ${error.message}`, "error");
            }
        }

        // Utility function for logging
        function log(elementId, message, type = "normal") {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type === "error" ? "error" : type === "success" ? "success-bg" : type === "warning" ? "warning" : ""}`;
        }

        // Initialize
        window.addEventListener("load", () => {
            console.log("üîß Fixed Debug tool loaded with correct Firebase config");
            setTimeout(updateStatus, 1000);
        });
    </script>
</body>
</html>
