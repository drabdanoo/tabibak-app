<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase SMS Test</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="config.js"></script>
</head>
<body style="font-family: Arial, sans-serif; padding: 20px;">
    <h1>üß™ Firebase SMS Authentication Test</h1>
    
    <div style="margin: 20px 0;">
        <label>Phone Number (+9647XXXXXXXXX):</label>
        <input type="text" id="phoneInput" value="+9647XXXXXXXXX" style="margin: 10px; padding: 8px; width: 200px;">
        <button onclick="testSMS()" style="padding: 8px 16px;">Send SMS Test</button>
    </div>
    
    <div style="margin: 20px 0;">
        <label>Verification Code:</label>
        <input type="text" id="codeInput" placeholder="Enter 6-digit code" style="margin: 10px; padding: 8px; width: 150px;">
        <button onclick="verifyCode()" style="padding: 8px 16px;">Verify Code</button>
    </div>
    
    <div id="logs" style="background: #f5f5f5; padding: 15px; margin: 20px 0; border-radius: 5px; white-space: pre-wrap; font-family: monospace; max-height: 400px; overflow-y: auto;"></div>
    
    <div id="recaptcha-container"></div>

    <script>
        let confirmationResult = null;
        let recaptchaVerifier = null;
        
        function log(message) {
            const logDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        // Initialize Firebase
        try {
            log('üöÄ Initializing Firebase...');
            firebase.initializeApp(window.__MC_ENV__.FIREBASE_CONFIG);
            log('‚úÖ Firebase initialized successfully');
            log('Project ID: ' + window.__MC_ENV__.FIREBASE_CONFIG.projectId);
        } catch (error) {
            log('‚ùå Firebase initialization failed: ' + error.message);
        }
        
        function initRecaptcha() {
            try {
                if (!recaptchaVerifier) {
                    log('üîß Initializing reCAPTCHA...');
                    log('üåê Current domain: ' + window.location.hostname);
                    
                    recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                        'size': 'invisible',
                        'callback': function(response) {
                            log('‚úÖ reCAPTCHA solved successfully');
                        },
                        'expired-callback': function() {
                            log('‚ö†Ô∏è reCAPTCHA expired, need to retry');
                        },
                        'error-callback': function(error) {
                            log('‚ùå reCAPTCHA error: ' + error);
                        }
                    });
                    
                    // Try to render immediately to catch domain issues
                    recaptchaVerifier.render().then(function(widgetId) {
                        log('‚úÖ reCAPTCHA rendered successfully (ID: ' + widgetId + ')');
                    }).catch(function(error) {
                        log('‚ùå reCAPTCHA render failed: ' + error.message);
                        if (error.message.includes('domain')) {
                            log('üîß DOMAIN ISSUE: Add ' + window.location.hostname + ' to reCAPTCHA allowed domains');
                        }
                    });
                    
                    log('‚úÖ reCAPTCHA verifier created');
                }
            } catch (error) {
                log('‚ùå reCAPTCHA initialization failed: ' + error.message);
                if (error.message.includes('domain')) {
                    log('üîß SOLUTION: Configure reCAPTCHA domains in Firebase Console');
                }
            }
        }
        
        async function testSMS() {
            const phone = document.getElementById('phoneInput').value;
            
            try {
                log('üì± Testing SMS to: ' + phone);
                
                // Initialize reCAPTCHA
                initRecaptcha();
                
                // Check authentication providers
                log('üîç Checking Firebase Auth configuration...');
                
                // Send SMS
                log('üì§ Attempting to send SMS...');
                confirmationResult = await firebase.auth().signInWithPhoneNumber(phone, recaptchaVerifier);
                log('‚úÖ SMS sent successfully! Check your phone.');
                
            } catch (error) {
                log('‚ùå SMS Error: ' + error.code + ' - ' + error.message);
                
                if (error.code === 'auth/operation-not-allowed') {
                    log('üìã SOLUTION: Enable Phone Authentication in Firebase Console:');
                    log('   1. Go to https://console.firebase.google.com/project/medconnect-2/authentication/providers');
                    log('   2. Click on "Phone" provider');
                    log('   3. Click "Enable" and save');
                } else if (error.code === 'auth/invalid-phone-number') {
                    log('üìã SOLUTION: Use correct phone format: +9647XXXXXXXXX');
                } else if (error.code === 'auth/too-many-requests') {
                    log('üìã SOLUTION: Wait a while before trying again (rate limited)');
                }
            }
        }
        
        async function verifyCode() {
            const code = document.getElementById('codeInput').value;
            
            if (!confirmationResult) {
                log('‚ùå No SMS sent yet. Send SMS first.');
                return;
            }
            
            try {
                log('üîç Verifying code: ' + code);
                const result = await confirmationResult.confirm(code);
                log('‚úÖ Phone verified successfully!');
                log('User UID: ' + result.user.uid);
            } catch (error) {
                log('‚ùå Verification failed: ' + error.message);
            }
        }
        
        // Log initial state
        log('üè• MedConnect SMS Test Ready');
        log('Environment: ' + window.__MC_ENV__.ENV);
    </script>
</body>
</html>